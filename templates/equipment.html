{% extends "base.html" %}

{% block title %}Управление оборудованием{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="bi bi-gear"></i> Управление оборудованием</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEquipmentModal">
            <i class="bi bi-plus-circle"></i> Добавить оборудование
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#evaluateConfigModal">
            <i class="bi bi-clipboard-check"></i> Оценить конфигурацию
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if equipment %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Помещение</th>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Мощность (W)</th>
                                <th>Статус</th>
                                <th>Автоматический режим</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for eq in equipment %}
                            <tr>
                                <td>{{ eq.id }}</td>
                                <td>{{ eq.room_name }}</td>
                                <td><strong>{{ eq.name }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary">{{ eq.equipment_type }}</span>
                                </td>
                                <td>{{ eq.power or '-' }}</td>
                                <td>
                                    <span class="badge bg-{% if eq.status == 'on' %}success{% elif eq.status == 'maintenance' %}warning{% else %}secondary{% endif %}">
                                        {{ eq.status }}
                                    </span>
                                </td>
                                <td>
                                    <input type="checkbox" {% if eq.auto_mode %}checked{% endif %} 
                                           onchange="toggleAutoMode({{ eq.id }}, this.checked)">
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="toggleStatus({{ eq.id }}, 'on')">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="toggleStatus({{ eq.id }}, 'off')">
                                        <i class="bi bi-stop-fill"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Оборудования пока нет. Создайте первое оборудование.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления оборудования -->
<div class="modal fade" id="addEquipmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить оборудование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addEquipmentForm">
                    <div class="mb-3">
                        <label for="equipmentRoom" class="form-label">Помещение</label>
                        <select class="form-control" id="equipmentRoom" required>
                            {% for room in rooms %}
                            <option value="{{ room.id }}">{{ room.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentType" class="form-label">Тип оборудования</label>
                        <select class="form-control" id="equipmentType" required>
                            <option value="heating">Отопление</option>
                            <option value="ventilation">Вентиляция</option>
                            <option value="air_conditioner">Кондиционер</option>
                            <option value="humidifier">Увлажнитель</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentName" class="form-label">Название</label>
                        <input type="text" class="form-control" id="equipmentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentPower" class="form-label">Мощность (W)</label>
                        <input type="number" step="0.01" class="form-control" id="equipmentPower">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addEquipment()">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно оценки конфигурации -->
<div class="modal fade" id="evaluateConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Оценка конфигурации оборудования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="evalRoom" class="form-label">Помещение</label>
                    <select class="form-control" id="evalRoom">
                        {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="evalEquipmentList" class="mb-3">
                    <button class="btn btn-sm btn-secondary" onclick="addEvalEquipment()">
                        <i class="bi bi-plus"></i> Добавить оборудование для оценки
                    </button>
                    <div id="evalEquipmentItems"></div>
                </div>
                <button class="btn btn-success" onclick="evaluateConfiguration()">
                    <i class="bi bi-check-circle"></i> Оценить
                </button>
                <div id="evaluationResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let evalEquipmentCounter = 0;

function addEquipment() {
    const data = {
        room_id: document.getElementById('equipmentRoom').value,
        equipment_type: document.getElementById('equipmentType').value,
        name: document.getElementById('equipmentName').value,
        power: document.getElementById('equipmentPower').value
    };
    
    fetch('/api/equipment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    });
}

function toggleStatus(equipmentId, status) {
    fetch(`/api/equipment/${equipmentId}/status`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: status})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    });
}

function toggleAutoMode(equipmentId, autoMode) {
    fetch(`/api/equipment/${equipmentId}/status`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: 'off', auto_mode: autoMode})
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            alert('Ошибка: ' + result.error);
        }
    });
}

function addEvalEquipment() {
    const container = document.getElementById('evalEquipmentItems');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'card mb-2 p-2';
    itemDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <select class="form-control form-control-sm eval-type">
                    <option value="heating">Отопление</option>
                    <option value="ventilation">Вентиляция</option>
                    <option value="air_conditioner">Кондиционер</option>
                    <option value="humidifier">Увлажнитель</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm eval-name" placeholder="Название">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control form-control-sm eval-power" placeholder="Мощность (W)">
            </div>
            <div class="col-md-1">
                <button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
            </div>
        </div>
    `;
    container.appendChild(itemDiv);
}

function evaluateConfiguration() {
    const items = document.getElementById('evalEquipmentItems').children;
    const equipment = [];
    
    for (let item of items) {
        equipment.push({
            type: item.querySelector('.eval-type').value,
            name: item.querySelector('.eval-name').value,
            power: parseFloat(item.querySelector('.eval-power').value) || 0
        });
    }
    
    const data = {
        room_id: document.getElementById('evalRoom').value,
        equipment: equipment
    };
    
    fetch('/api/equipment/evaluate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const resultDiv = document.getElementById('evaluationResult');
            let html = '<div class="alert alert-' + (result.evaluation.is_valid ? 'success' : 'warning') + '">';
            html += '<h6>Результат оценки:</h6>';
            html += '<ul>';
            for (let rec of result.evaluation.recommendations) {
                html += `<li><strong>${rec.type}:</strong> ${rec.message}</li>`;
            }
            html += '</ul></div>';
            resultDiv.innerHTML = html;
        } else {
            alert('Ошибка: ' + result.error);
        }
    });
}
</script>
{% endblock %}
